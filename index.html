<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Christmas Tree Free Draw â€” One Save Only</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #0f1724;
      --accent: #10b981;
      --muted: #9aa4b2;
    }
    body {
      margin: 0;
      font-family: Inter, system-ui, Segoe UI, Arial;
      background: linear-gradient(180deg, #071025 0%, #0b1220 60%);
      color: #e6eef6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      padding: 28px;
      box-sizing: border-box;
    }
    .app {
      max-width: 1100px;
      width: 100%;
      display: grid;
      grid-template-columns: 480px 1fr;
      gap: 20px;
      align-items: start;
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 6px 20px rgba(2,6,23,0.6);
    }
    h1 {
      margin: 0 0 8px;
      font-size: 20px;
    }
    p.lead {
      margin: 0 0 12px;
      color: var(--muted);
    }
    .designer {
      height: 560px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .canvas {
      flex: 1;
      position: relative;
      background: linear-gradient(180deg, #071726, #06202a);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    svg.tree {
      width: 240px;
      height: 330px;
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1;
      pointer-events: none;
    }
    canvas#drawCanvas {
      position: absolute;
      top: 0px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2;
      cursor: crosshair;
      border-radius: 10px;
    }
    .controls {
      top: 90px;
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: auto; /* pushes it to the bottom of the designer area */
      padding-top: 30px; /* optional, add a bit of spacing from the tree */
    }

    .color {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.15);
      cursor: pointer;
      transition: transform 0.2s, border-color 0.2s;
    }
    .color:hover {
      transform: scale(1.1);
      border-color: var(--accent);
    }
    .btn {
      background: var(--accent);
      color: #072024;
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: opacity 0.2s;
    }
    .btn.secondary {
      background: transparent;
      color: var(--muted);
      border: 1px solid rgba(255,255,255,0.04);
    }
    .btn:hover { opacity: 0.9; }
    .muted {
      color: var(--muted);
      font-size: 13px;
    }
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
    }
    .thumb {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      padding: 8px;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
    }
    .thumb img {
      width: 120px;
      height: 160px;
      object-fit: cover;
      border-radius: 8px;
    }
    footer {
      width: 100%;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      margin-top: 85px;
      padding: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent);
      border-top: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
    }
    .disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .notice {
      background: #08303a;
      padding: 8px;
      border-radius: 8px;
      color: #bfeee1;
      margin-bottom: 8px;
    }
    .side-controls {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      padding: 16px;
      border-radius: 10px;
      gap: 6px;
      width: 180px;
      height: fit-content;
   }

  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>Christmas Tree Free Draw</h1>
      <p class="lead">Draw or decorate the Christmas tree however you want! You can save your drawing only once.</p>

      <div class="designer">
        <div id="status" class="notice">Initializing...</div>
        <div class="canvas" style="width:360px;height:480px;">
          <svg class="tree" viewBox="0 0 400 600">
            <defs>
              <linearGradient id="g1" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#10b981"/>
                <stop offset="100%" stop-color="#065f46"/>
              </linearGradient>
            </defs>
            <rect x="180" y="520" width="40" height="60" rx="5" fill="#6b4226"/>
            <path d="M200 60 L80 260 L320 260 Z" fill="url(#g1)" />
            <path d="M200 180 L60 380 L340 380 Z" fill="url(#g1)" />
            <path d="M200 300 L40 500 L360 500 Z" fill="url(#g1)" />
          </svg>

          <canvas id="drawCanvas" width="360" height="480"></canvas>
        </div>

        <!-- Controls -->
        

        <p class="muted">Use your mouse (or touch) to draw. You can use the eraser or pick any custom color!</p>
      </div>
    </div>

  <div class="side-controls">
      <div class="muted">Color:</div>
      <div id="palette" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;"></div>

      <input type="color" id="customColor" value="#ffffff"
        style="width:36px;height:36px;border:none;border-radius:50%;cursor:pointer;background:none;padding:0;margin-bottom:10px;">

      <div class="muted">Brush:</div>
      <select id="size" style="padding:6px;border-radius:6px;background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.06);margin-bottom:12px;">
        <option value="2">Thin</option>
        <option value="5" selected>Medium</option>
        <option value="10">Thick</option>
        <option value="20">Extra Thick</option>
      </select>

      <button id="eraserBtn" class="btn secondary" style="margin-bottom:8px;">Eraser</button>
      <button id="saveBtn" class="btn" style="margin-bottom:8px;">Save Drawing (once)</button>
      <button id="clearBtn" class="btn secondary">Clear</button>
    </div>

    <div class="card">
      <h1>Public Drawings</h1>
      <div id="gallery" class="gallery"></div>
      <div id="viewer" style="display:none;margin-top:12px">
        <h3 style="margin:4px 0">Viewing drawing</h3>
        <div id="viewArea" style="background:linear-gradient(180deg,#05262b,#04222a);padding:10px;border-radius:8px"></div>
      </div>
    </div>
  </div>

  <footer>ðŸŽ„ Built with Firebase â€¢ Free Draw Edition</footer>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyAoNG82_VQO7uBk5wRyvOBtpSc69ksWcXc",
    authDomain: "christmasgenshincuties.firebaseapp.com",
    projectId: "christmasgenshincuties",
    storageBucket: "christmasgenshincuties.firebasestorage.app",
    messagingSenderId: "672301767030",
    appId: "1:672301767030:web:d93bd7c4d23b5057384257"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const canvas = document.getElementById('drawCanvas');
  const ctx = canvas.getContext('2d');
  const paletteEl = document.getElementById('palette');
  const sizeEl = document.getElementById('size');
  const saveBtn = document.getElementById('saveBtn');
  const clearBtn = document.getElementById('clearBtn');
  const eraserBtn = document.getElementById('eraserBtn'); /* NEW */
  const customColor = document.getElementById('customColor'); /* NEW */
  const statusEl = document.getElementById('status');
  const galleryEl = document.getElementById('gallery');
  const viewArea = document.getElementById('viewArea');

  const colors = ['#EF4444','#F59E0B','#10B981','#3B82F6','#8B5CF6','#EC4899','#FDE68A','#FFFFFF','#000000'];
  let selectedColor = colors[0];
  let erasing = false; /* NEW */

  colors.forEach(c=>{
    const d=document.createElement('div');
    d.className='color';
    d.style.background=c;
    d.onclick=()=>{selectedColor=c;erasing=false;updateSelection(d);};
    paletteEl.appendChild(d);
  });
  paletteEl.firstChild.style.outline='3px solid rgba(255,255,255,0.12)';

  function updateSelection(el){
    document.querySelectorAll('.color').forEach(x=>x.style.outline='');
    el.style.outline='3px solid rgba(255,255,255,0.12)';
  }

  customColor.addEventListener('input',()=>{
    selectedColor=customColor.value;
    erasing=false;
    document.querySelectorAll('.color').forEach(x=>x.style.outline='');
  });

  eraserBtn.onclick=()=>{
    erasing=true;
    document.querySelectorAll('.color').forEach(x=>x.style.outline='');
  };

  let drawing=false, saved=false, uid=null;

  function getPos(e){
    const rect=canvas.getBoundingClientRect();
    const x=(e.touches?e.touches[0].clientX:e.clientX)-rect.left;
    const y=(e.touches?e.touches[0].clientY:e.clientY)-rect.top;
    return {x,y};
  }

  function startDraw(e){if(saved)return;e.preventDefault();drawing=true;const pos=getPos(e);ctx.beginPath();ctx.moveTo(pos.x,pos.y);}
  function draw(e){
    if(!drawing||saved)return;
    e.preventDefault();
    const pos=getPos(e);
    ctx.lineTo(pos.x,pos.y);
    ctx.strokeStyle = erasing ? '#06202a' : selectedColor; /* NEW eraser uses bg color */
    ctx.lineWidth = sizeEl.value;
    ctx.lineCap='round';
    ctx.lineJoin='round';
    ctx.stroke();
  }
  function endDraw(e){if(saved)return;drawing=false;ctx.closePath();}

  canvas.addEventListener('mousedown',startDraw);
  canvas.addEventListener('mousemove',draw);
  canvas.addEventListener('mouseup',endDraw);
  canvas.addEventListener('mouseleave',endDraw);
  canvas.addEventListener('touchstart',startDraw);
  canvas.addEventListener('touchmove',draw);
  canvas.addEventListener('touchend',endDraw);

  clearBtn.onclick=()=>{if(saved)return;ctx.clearRect(0,0,canvas.width,canvas.height);};

  async function init(){
    statusEl.textContent="Signing in...";
    try{
      const cred=await auth.signInAnonymously();
      uid=cred.user.uid;
      statusEl.textContent="Checking saved drawing...";
      const doc=await db.collection("drawings").doc(uid).get();
      if(doc.exists){
        saved=true;
        const img=new Image();
        img.onload=()=>ctx.drawImage(img,0,0);
        img.src=doc.data().image;
        statusEl.textContent="You already saved your drawing â€” editing disabled.";
        document.querySelectorAll('.btn').forEach(b=>b.classList.add('disabled'));
      }else{
        statusEl.textContent="You can draw and save once. Session ID: "+uid;
      }
      loadGallery();
    }catch(e){
      console.error(e);
      statusEl.textContent="Firebase init failed.";
    }
  }

  saveBtn.onclick = async () => {
    if (saved) return;
    statusEl.textContent = "Saving...";
    const combined = document.createElement("canvas");
    combined.width = canvas.width;
    combined.height = canvas.height;
    const ctx2 = combined.getContext("2d");
    const svg = document.querySelector(".tree");
    const svgData = new XMLSerializer().serializeToString(svg);
    const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(svgBlob);
    const treeImg = new Image();
    treeImg.onload = async () => {
      ctx2.drawImage(treeImg, 0, 0, combined.width, combined.height);
      URL.revokeObjectURL(url);
      ctx2.drawImage(canvas, 0, 0);
      const imgData = combined.toDataURL("image/png");
      try {
        await db.collection("drawings").doc(uid).set({
          image: imgData,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        saved = true;
        statusEl.textContent = "Saved successfully!";
        document.querySelectorAll(".btn").forEach(b => b.classList.add("disabled"));
        loadGallery();
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Save failed â€” check Firestore rules.";
      }
    };
    treeImg.src = url;
  };

  async function loadGallery(){
    galleryEl.innerHTML="<div class='muted'>Loading gallery...</div>";
    try{
      const snap=await db.collection("drawings").orderBy("createdAt","desc").limit(48).get();
      galleryEl.innerHTML="";
      snap.forEach(doc=>{
        const data=doc.data();
        const div=document.createElement("div");
        div.className="thumb";
        const img=document.createElement("img");
        img.src=data.image;
        div.appendChild(img);
        const meta=document.createElement("div");
        meta.className="muted";
        meta.style.fontSize="12px";
        meta.textContent=(data.createdAt&&data.createdAt.toDate)?data.createdAt.toDate().toLocaleString():"";
        div.appendChild(meta);
        div.onclick=()=>viewDrawing(data);
        galleryEl.appendChild(div);
      });
      if(galleryEl.children.length===0)galleryEl.innerHTML="<div class='muted'>No drawings yet. Be the first!</div>";
    }catch(e){
      console.error(e);
      galleryEl.innerHTML="<div class='muted'>Failed to load gallery.</div>";
    }
  }

  function viewDrawing(data){
    viewArea.innerHTML="";
    const img=document.createElement("img");
    img.src=data.image;
    img.style.width="240px";
    img.style.borderRadius="8px";
    viewArea.appendChild(img);
    document.getElementById("viewer").style.display="block";
  }

  init();
  </script>
</body>
</html>
